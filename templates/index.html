{% extends "base.html" %}

{% block title %}我的美食地圖 - Foodie Finder{% endblock %}

{% block content %}

<nav>
    <div class="user-actions">
        {% if g.user %}
            <span>您好, {{ g.user.username }}</span>
            <a href="{{ url_for('logout') }}">登出</a>
        {% else %}
            <a href="{{ url_for('register') }}">註冊</a>
            <a href="{{ url_for('login') }}">登入</a>
        {% endif %}
    </div>
</nav>

<div class="hero-section">
    <h1 class="hero-title">Foodie Finder</h1>
    <div class="hero-images">
        <img src="{{ url_for('static', filename='images/raccoon.png') }}" alt="思考中的浣熊" class="raccoon-img">
        <img src="{{ url_for('static', filename='images/sandwich.png') }}" alt="三明治" class="food-icon icon-sandwich">
        <img src="{{ url_for('static', filename='images/fish.png') }}" alt="魚" class="food-icon icon-fish">
        <img src="{{ url_for('static', filename='images/apple.png') }}" alt="蘋果" class="food-icon icon-apple">
        <img src="{{ url_for('static', filename='images/banana.png') }}" alt="香蕉" class="food-icon icon-banana">
    </div>
</div>

<div class="card">
    <h2>今天吃什麼？</h2>
    <form action="/search" method="post"><div class="custom-select-wrapper" data-name="search_city"><input type="hidden" name="city"><div class="custom-select-trigger"><span class="selected-value">-- 請選擇縣市 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><div class="custom-select-wrapper" data-name="search_district"><input type="hidden" name="district"><div class="custom-select-trigger"><span class="selected-value">-- (選填) 地區 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><div class="custom-select-wrapper" data-name="search_station"><input type="hidden" name="station"><div class="custom-select-trigger"><span class="selected-value">-- (選填) 捷運站 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><div class="form-row"><button type="submit" name="action" value="檢視所有" class="button button-secondary">檢視店家</button><button type="submit" name="action" value="隨機推薦" class="button button-primary">隨機推薦</button></div></form>
</div>
<div class="card results">
    <h2>搜尋結果</h2>
    {% if recommendation %}<div class="recommendation-result"><h3>為您推薦：</h3><p>{{ recommendation.name }}</p><small>({{ recommendation.city }} - {{ recommendation.district }} - {{ recommendation.station }})</small></div>{% elif search_results %}<h3>符合條件的店家列表：</h3><ul>{% for r in search_results %}<li>{{ r.name }} <small>({{ r.district }} - {{ r.station }})</small></li>{% else %}<li>找不到符合條件的店家。</li>{% endfor %}</ul>{% else %}<p style="text-align: center; color: #777;">請選擇條件後，點擊按鈕開始搜尋。</p>{% endif %}
</div>
<div class="card">
    <h2>目前店家列表</h2>
    <form action="/" method="get"><div class="custom-select-wrapper" data-name="filter_city"><input type="hidden" name="filter_city" value="{{ filter_values.filter_city }}"><div class="custom-select-trigger"><span class="selected-value">-- 篩選縣市 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><div class="custom-select-wrapper" data-name="filter_district"><input type="hidden" name="filter_district" value="{{ filter_values.filter_district }}"><div class="custom-select-trigger"><span class="selected-value">-- 篩選地區 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><div class="form-actions-row"><a href="/" class="button button-secondary">清除篩選</a><button type="submit" class="button button-primary">進行篩選</button></div></form>
    <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--input-bg);">
    <ul class="restaurant-list">
        {% for restaurant in restaurants %}
            <li>
                <div class="info"><span class="name">{{ restaurant.name }}</span><span class="location">{{ restaurant.city }} - {{ restaurant.district }}</span></div>
                <div class="actions">
                    <a href="{{ url_for('edit', restaurant_id=restaurant.id) }}" class="btn-edit">編輯</a>
                    <form action="{{ url_for('delete', restaurant_id=restaurant.id) }}" method="post" onsubmit="return confirm('您確定要刪除「{{ restaurant.name }}」嗎？');" style="margin:0;"><button type="submit" class="btn-delete">刪除</button></form>
                </div>
            </li>
        {% else %}
            <li>您還沒有新增任何店家喔！</li>
        {% endfor %}
    </ul>
</div>
<div class="card">
    <h2>新增美食店家</h2>
    <form action="/add" method="post"><div class="custom-select-wrapper" data-name="add_city"><input type="hidden" name="city" required><div class="custom-select-trigger"><span class="selected-value">-- 請選擇縣市 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><div class="custom-select-wrapper" data-name="add_district"><input type="hidden" name="district" required><div class="custom-select-trigger"><span class="selected-value">-- 請選擇地區 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><div class="custom-select-wrapper" data-name="add_station"><input type="hidden" name="station"><div class="custom-select-trigger"><span class="selected-value">-- (選填) 捷運站 --</span><div class="arrow"></div></div><div class="custom-select-panel"></div></div><input type="text" name="name" placeholder="店名" required><button type="submit" class="button button-primary">新增店家</button></form>
</div>

<script>
    // JavaScript 內容與上一版完全相同
    document.addEventListener('DOMContentLoaded', function() {
        const locationData = {{ location_data | tojson | safe }};
        const filterValues = {{ filter_values | tojson | safe }};
        const sortedCities = {{ location_data.keys() | list | tojson | safe }};
        function initializeCascadingSelect(prefix) { /* ... 內容不變 ... */ const cityWrapper = document.querySelector(`[data-name="${prefix}_city"]`); const districtWrapper = document.querySelector(`[data-name="${prefix}_district"]`); const stationWrapper = document.querySelector(`[data-name="${prefix}_station"]`); if (!cityWrapper) return; populate(sortedCities, cityWrapper); cityWrapper.addEventListener('optionSelected', e => { reset(districtWrapper); if (stationWrapper) reset(stationWrapper); const districts = locationData[e.detail.value] ? Object.keys(locationData[e.detail.value]) : []; populate(districts, districtWrapper); }); if (districtWrapper) { districtWrapper.addEventListener('optionSelected', e => { if (stationWrapper) { reset(stationWrapper); const selectedCity = cityWrapper.querySelector('input').value; const stations = (locationData[selectedCity] && locationData[selectedCity][e.detail.value]) ? locationData[selectedCity][e.detail.value] : []; populate(stations, stationWrapper); } }); } }
        document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => { const trigger = wrapper.querySelector('.custom-select-trigger'); const panel = wrapper.querySelector('.custom-select-panel'); const hiddenInput = wrapper.querySelector('input[type="hidden"]'); const selectedValueSpan = wrapper.querySelector('.selected-value'); trigger.addEventListener('click', () => { document.querySelectorAll('.custom-select-wrapper').forEach(otherWrapper => { if (otherWrapper !== wrapper) { otherWrapper.classList.remove('open'); } }); wrapper.classList.toggle('open'); }); panel.addEventListener('click', e => { if (e.target.classList.contains('custom-select-option')) { const value = e.target.dataset.value; selectedValueSpan.textContent = value; hiddenInput.value = value; panel.querySelector('.selected')?.classList.remove('selected'); e.target.classList.add('selected'); wrapper.classList.remove('open'); wrapper.dispatchEvent(new CustomEvent('optionSelected', { detail: { value: value } })); } }); });
        function populate(options, wrapper) { const panel = wrapper?.querySelector('.custom-select-panel'); if (!panel) return; panel.innerHTML = ''; options.forEach(optionValue => { const optionDiv = document.createElement('div'); optionDiv.className = 'custom-select-option'; optionDiv.textContent = optionValue; optionDiv.dataset.value = optionValue; panel.appendChild(optionDiv); }); }
        function reset(wrapper) { if (!wrapper) return; const placeholders = { 'search_district': '-- (選填) 地區 --', 'search_station': '-- (選填) 捷運站 --', 'add_district': '-- 請選擇地區 --', 'add_station': '-- (選填) 捷運站 --', 'filter_district': '-- 篩選地區 --', }; wrapper.querySelector('.selected-value').textContent = placeholders[wrapper.dataset.name] || '-- 請選擇 --'; wrapper.querySelector('input').value = ''; wrapper.querySelector('.custom-select-panel').innerHTML = ''; }
        window.addEventListener('click', e => { if (!e.target.closest('.custom-select-wrapper')) { document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open')); }});
        initializeCascadingSelect('search');
        initializeCascadingSelect('add');
        initializeCascadingSelect('filter');
        const selectedCity = filterValues.filter_city;
        const selectedDistrict = filterValues.filter_district;
        if (selectedCity) { document.querySelector('[data-name="filter_city"] .selected-value').textContent = selectedCity; const filterDistrictWrapper = document.querySelector('[data-name="filter_district"]'); populate(locationData[selectedCity] ? Object.keys(locationData[selectedCity]) : [], filterDistrictWrapper); if (selectedDistrict) { filterDistrictWrapper.querySelector('.selected-value').textContent = selectedDistrict; } }
    });
</script>
{% endblock %}